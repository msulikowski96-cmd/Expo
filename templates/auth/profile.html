{% extends "base.html" %}
{% block title %}Profil użytkownika - CV Optimizer Pro{% endblock %}

{% block content %}
<div class="container-fluid min-vh-100" style="background: var(--hero-gradient); padding-top: 100px; padding-bottom: 40px;">
    <div class="container">
        <!-- Header Profile Card -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-10">
                <div class="card shadow-lg border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div class="d-flex align-items-center mb-3 mb-md-0">
                                <div class="position-relative me-4">
                                    <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center shadow-lg" 
                                         style="width: 80px; height: 80px; background: var(--primary-gradient);">
                                        <i class="bi bi-person-circle text-white" style="font-size: 2.5rem;"></i>
                                    </div>
                                    {% if stats.is_premium %}
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning">
                                        <i class="bi bi-star-fill"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                    <h2 class="mb-1 fw-bold text-dark">{{ current_user.first_name }} {{ current_user.last_name }}</h2>
                                    <p class="text-muted mb-1">@{{ current_user.username }}</p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-envelope me-2"></i>{{ current_user.email }}
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-calendar me-2"></i>Dołączył {{ stats.account_age }} dni temu
                                    </p>
                                </div>
                            </div>

                            <div class="d-flex flex-column align-items-end">
                                {% if stats.is_premium %}
                                <div class="badge bg-warning text-dark px-3 py-2 rounded-pill mb-2">
                                    <i class="bi bi-star-fill me-1"></i>Konto Premium
                                </div>
                                {% else %}
                                <div class="badge bg-secondary px-3 py-2 rounded-pill mb-2">
                                    <i class="bi bi-person me-1"></i>Konto Basic
                                </div>
                                {% endif %}

                                {% if stats.last_login %}
                                <small class="text-muted">
                                    Ostatnie logowanie: {{ stats.last_login.strftime('%d.%m.%Y %H:%M') }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards Row -->
        <div class="row justify-content-center g-4 mb-5">
            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-file-earmark-text text-white"></i>
                        </div>
                        <h3 class="fw-bold text-primary mb-1">{{ stats.cv_count }}</h3>
                        <p class="small text-muted mb-0">Przesłane CV</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-magic text-white"></i>
                        </div>
                        <h3 class="fw-bold text-success mb-1">{{ stats.optimized_count }}</h3>
                        <p class="small text-muted mb-0">Zoptymalizowane</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-info rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-graph-up text-white"></i>
                        </div>
                        <h3 class="fw-bold text-info mb-1">{{ stats.analyzed_count }}</h3>
                        <p class="small text-muted mb-0">Przeanalizowane</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-speedometer2 text-white"></i>
                        </div>
                        <h3 class="fw-bold text-warning mb-1">{{ stats.success_rate }}%</h3>
                        <p class="small text-muted mb-0">Skuteczność</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-4 col-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-activity text-white"></i>
                        </div>
                        <h3 class="fw-bold text-danger mb-1">{{ stats.recent_activity }}</h3>
                        <p class="small text-muted mb-0">Ostatnie 30 dni</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Statistics Row -->
        <div class="row justify-content-center g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--primary-gradient);">
                            <i class="bi bi-box-arrow-in-right text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #8b5cf6;">{{ stats.total_logins }}</h3>
                        <p class="small text-muted mb-0">Liczba logowań</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--success-gradient);">
                            <i class="bi bi-clock text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #06b6d4;">{{ stats.total_time_spent }}</h3>
                        <p class="small text-muted mb-0">Minut w aplikacji</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--warning-gradient);">
                            <i class="bi bi-heart text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #f43f5e;">
                            {% if stats.cv_count > 0 %}{{ (stats.optimized_count / stats.cv_count * 100)|round(0)|int }}{% else %}0{% endif %}%
                        </h3>
                        <p class="small text-muted mb-0">Poziom zadowolenia</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card h-100 border-0 glassmorphism text-center" style="border-radius: 15px;">
                    <div class="card-body p-3">
                        <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 50px; height: 50px; background: var(--success-gradient);">
                            <i class="bi bi-trophy text-white"></i>
                        </div>
                        <h3 class="fw-bold mb-1" style="color: #14b8a6;">
                            {% if stats.account_age < 7 %}Nowicjusz{% elif stats.account_age < 30 %}Aktywny{% elif stats.account_age < 90 %}Ekspert{% else %}Mistrz{% endif %}
                        </h3>
                        <p class="small text-muted mb-0">Status użytkownika</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics and Recent Activity -->
        <div class="row justify-content-center g-4">
            <!-- Progress Chart Card -->
            <div class="col-lg-5">
                <div class="card h-100 border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center p-3 pb-2">
                            <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--primary-gradient);">
                                <i class="bi bi-bar-chart text-white"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-1 fw-bold text-dark">Postęp Optymalizacji</h4>
                                <p class="mb-0 text-muted">Twoja skuteczność w liczbach</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        <!-- Success Rate Circle -->
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block">
                                <svg width="120" height="120" class="progress-ring">
                                    <circle cx="60" cy="60" r="50" stroke="#e9ecef" stroke-width="8" fill="transparent"/>
                                    <circle cx="60" cy="60" r="50" stroke="url(#gradient)" stroke-width="8" fill="transparent"
                                            stroke-dasharray="{{ (stats.success_rate / 100) * 314 }} 314" stroke-linecap="round"
                                            style="transform: rotate(-90deg); transform-origin: 60px 60px;"/>
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#667eea"/>
                                            <stop offset="100%" style="stop-color:#764ba2"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <div class="fw-bold h3 text-primary">{{ stats.success_rate }}%</div>
                                    <small class="text-muted">Skuteczność</small>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Bars -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Zoptymalizowane</span>
                                <span class="fw-bold">{{ stats.optimized_count }}/{{ stats.cv_count }}</span>
                            </div>
                            <div class="progress" style="height: 8px; border-radius: 10px;">
                                <div class="progress-bar bg-success" style="width: {% if stats.cv_count > 0 %}{{ (stats.optimized_count / stats.cv_count) * 100 }}{% else %}0{% endif %}%; border-radius: 10px;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Przeanalizowane</span>
                                <span class="fw-bold">{{ stats.analyzed_count }}/{{ stats.cv_count }}</span>
                            </div>
                            <div class="progress" style="height: 8px; border-radius: 10px;">
                                <div class="progress-bar bg-info" style="width: {% if stats.cv_count > 0 %}{{ (stats.analyzed_count / stats.cv_count) * 100 }}{% else %}0{% endif %}%; border-radius: 10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Card -->
            <div class="col-lg-5">
                <div class="card h-100 border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-header border-0 bg-transparent pb-0">
                        <div class="d-flex align-items-center p-3 pb-2">
                            <div class="bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" 
                                 style="width: 50px; height: 50px; background: var(--primary-gradient);">
                                <i class="bi bi-clock-history text-white"></i>
                            </div>
                            <div>
                                <h4 class="card-title mb-1 fw-bold text-dark">Ostatnia Aktywność</h4>
                                <p class="mb-0 text-muted">Twoje najnowsze CV</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4 pt-2">
                        {% if recent_cvs %}
                        <div class="timeline">
                            {% for cv in recent_cvs %}
                            <div class="d-flex align-items-start mb-3">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3 flex-shrink-0" 
                                     style="width: 35px; height: 35px;">
                                    <i class="bi bi-file-earmark-text text-white" style="font-size: 0.9rem;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1 text-dark">{{ cv.job_title }}</h6>
                                    <p class="text-muted mb-1 small">{{ cv.filename }}</p>
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted me-3">
                                            <i class="bi bi-calendar me-1"></i>{{ cv.created_at.strftime('%d.%m.%Y') }}
                                        </small>
                                        {% if cv.optimized_cv %}
                                        <span class="badge bg-success rounded-pill">Zoptymalizowane</span>
                                        {% endif %}
                                        {% if cv.cv_analysis %}
                                        <span class="badge bg-info rounded-pill ms-1">Przeanalizowane</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if not loop.last %}
                            <hr class="my-2 opacity-25">
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-file-earmark-x text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Nie przesłano jeszcze żadnego CV</p>
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-upload me-1"></i>Prześlij pierwsze CV
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row justify-content-center mt-4">
            <div class="col-12 col-lg-10">
                <div class="card border-0 glassmorphism" style="border-radius: 20px;">
                    <div class="card-body p-4 text-center">
                        <h5 class="mb-3 fw-bold text-dark">Zarządzaj swoim kontem</h5>
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-primary px-4 py-2" style="border-radius: 12px;">
                                <i class="bi bi-speedometer2 me-2"></i>Dashboard
                            </a>
                            {% if not stats.is_premium %}
                            <a href="{{ url_for('pricing') }}" class="btn btn-warning px-4 py-2" style="border-radius: 12px;">
                                <i class="bi bi-star me-2"></i>Przejdź na Premium
                            </a>
                            {% endif %}
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-light px-4 py-2" style="border-radius: 12px;">
                                <i class="bi bi-box-arrow-right me-2"></i>Wyloguj się
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status płatności -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card text-success"></i> Status płatności</h5>
                    </div>
                    <div class="card-body">
                        {% set payment_status = current_user.get_payment_status() %}

                        {% if payment_status.type == 'developer' %}
                            <div class="alert alert-info">
                                <i class="fas fa-code"></i> <strong>Konto deweloperskie</strong> - pełny dostęp do wszystkich funkcji
                            </div>
                        {% elif payment_status.type == 'subscription' %}
                            <div class="alert alert-success">
                                <i class="fas fa-crown"></i> <strong>Aktywna subskrypcja:</strong> {{ payment_status.plan }}
                                <br><small>Wygasa: {{ payment_status.expires.strftime('%d.%m.%Y') }}</small>
                            </div>
                            <a href="{{ url_for('pricing') }}" class="btn btn-outline-primary">
                                <i class="fas fa-cog"></i> Zarządzaj subskrypcją
                            </a>
                        {% elif payment_status.type == 'single' %}
                            <div class="alert alert-warning">
                                <i class="fas fa-ticket-alt"></i> <strong>Jednorazowa płatność</strong>
                                <br>Pozostało optymalizacji CV: <strong>{{ payment_status.optimizations_left }}</strong>
                            </div>
                            <a href="{{ url_for('pricing') }}" class="btn btn-success">
                                <i class="fas fa-upgrade"></i> Przejdź na pełny pakiet
                            </a>
                        {% else %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-user"></i> <strong>Konto darmowe</strong>
                                <br>Brak aktywnych płatności
                            </div>
                            <a href="{{ url_for('pricing') }}" class="btn btn-primary">
                                <i class="fas fa-shopping-cart"></i> Zobacz cennik
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animacja dla kół postępu
    const progressRings = document.querySelectorAll('.progress-ring circle:nth-child(2)');
    progressRings.forEach(ring => {
        const dashArray = ring.style.strokeDasharray;
        ring.style.strokeDasharray = '0 314';
        setTimeout(() => {
            ring.style.strokeDasharray = dashArray;
            ring.style.transition = 'stroke-dasharray 2s ease-in-out';
        }, 500);
    });

    // Animacja dla pasków postępu
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
            bar.style.transition = 'width 1.5s ease-in-out';
        }, 800);
    });
});
</script>
{% endblock %}